@model ERP.Models.Equipment

@{
    ViewData["Title"] = "Détails de l'équipement";
    var currentAssignment = Model.Assignments?.FirstOrDefault(a => a.ReturnDate == null);
}

<h1>Détails de l'équipement</h1>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">@Model.Name</h4>
                @switch (Model.Status)
                {
                    case ERP.Models.EquipmentStatus.Available:
                        <span class="badge bg-success fs-6">Disponible</span>
                        break;
                    case ERP.Models.EquipmentStatus.Assigned:
                        <span class="badge bg-primary fs-6">Attribué</span>
                        break;
                    case ERP.Models.EquipmentStatus.InMaintenance:
                        <span class="badge bg-warning fs-6">En maintenance</span>
                        break;
                    case ERP.Models.EquipmentStatus.Retired:
                        <span class="badge bg-secondary fs-6">Retiré</span>
                        break;
                    case ERP.Models.EquipmentStatus.Lost:
                        <span class="badge bg-danger fs-6">Perdu</span>
                        break;
                }
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Code d'inventaire</dt>
                    <dd class="col-sm-8"><code>@Model.InventoryCode</code></dd>

                    <dt class="col-sm-4">Numéro de série</dt>
                    <dd class="col-sm-8">@(Model.SerialNumber ?? "-")</dd>

                    <dt class="col-sm-4">Type</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-info">@Model.EquipmentType?.Name</span>
                        @if (!string.IsNullOrEmpty(Model.EquipmentType?.Category))
                        {
                            <small class="text-muted">(@Model.EquipmentType.Category)</small>
                        }
                    </dd>

                    <dt class="col-sm-4">Marque / Modèle</dt>
                    <dd class="col-sm-8">@Model.Brand @Model.Model</dd>

                    <dt class="col-sm-4">Date d'acquisition</dt>
                    <dd class="col-sm-8">@(Model.AcquisitionDate?.ToShortDateString() ?? "-")</dd>

                    <dt class="col-sm-4">Prix d'achat</dt>
                    <dd class="col-sm-8">@(Model.PurchasePrice?.ToString("C") ?? "-")</dd>

                    <dt class="col-sm-4">Fournisseur</dt>
                    <dd class="col-sm-8">@(Model.Supplier ?? "-")</dd>

                    <dt class="col-sm-4">Fin de garantie</dt>
                    <dd class="col-sm-8">
                        @if (Model.WarrantyEndDate.HasValue)
                        {
                            if (Model.WarrantyEndDate < DateTime.Today)
                            {
                                <span class="text-danger">@Model.WarrantyEndDate.Value.ToShortDateString() (Expirée)</span>
                            }
                            else
                            {
                                <span class="text-success">@Model.WarrantyEndDate.Value.ToShortDateString()</span>
                            }
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </dd>

                    <dt class="col-sm-4">Notes</dt>
                    <dd class="col-sm-8">@(Model.Notes ?? "-")</dd>
                </dl>
            </div>
        </div>

        @if (currentAssignment != null)
        {
            <div class="card mt-3 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Attribution actuelle</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Employé</dt>
                        <dd class="col-sm-8">
                            <a asp-controller="Employes" asp-action="Details" asp-route-id="@currentAssignment.EmployeeId">
                                @currentAssignment.Employee?.Prenom @currentAssignment.Employee?.Nom
                            </a>
                        </dd>

                        <dt class="col-sm-4">Date d'attribution</dt>
                        <dd class="col-sm-8">@currentAssignment.AssignmentDate.ToShortDateString()</dd>

                        <dt class="col-sm-4">État à l'attribution</dt>
                        <dd class="col-sm-8">
                            @switch (currentAssignment.ConditionAtAssignment)
                            {
                                case ERP.Models.AssignmentCondition.New:
                                    <span class="badge bg-success">Neuf</span>
                                    break;
                                case ERP.Models.AssignmentCondition.Good:
                                    <span class="badge bg-primary">Bon état</span>
                                    break;
                                case ERP.Models.AssignmentCondition.Fair:
                                    <span class="badge bg-warning">État correct</span>
                                    break;
                                case ERP.Models.AssignmentCondition.Poor:
                                    <span class="badge bg-danger">Mauvais état</span>
                                    break;
                            }
                        </dd>

                        @if (!string.IsNullOrEmpty(currentAssignment.AssignedBy))
                        {
                            <dt class="col-sm-4">Attribué par</dt>
                            <dd class="col-sm-8">@currentAssignment.AssignedBy</dd>
                        }

                        @if (!string.IsNullOrEmpty(currentAssignment.AssignmentNotes))
                        {
                            <dt class="col-sm-4">Notes</dt>
                            <dd class="col-sm-8">@currentAssignment.AssignmentNotes</dd>
                        }
                    </dl>
                </div>
            </div>
        }

        <h4 class="mt-4">Historique des attributions</h4>
        @if (Model.Assignments != null && Model.Assignments.Any())
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Employé</th>
                        <th>Date attribution</th>
                        <th>Date retour</th>
                        <th>État attribution</th>
                        <th>État retour</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var assignment in Model.Assignments.OrderByDescending(a => a.AssignmentDate))
                    {
                        <tr class="@(assignment.ReturnDate == null ? "table-primary" : "")">
                            <td>
                                <a asp-controller="Employes" asp-action="Details" asp-route-id="@assignment.EmployeeId">
                                    @assignment.Employee?.Prenom @assignment.Employee?.Nom
                                </a>
                            </td>
                            <td>@assignment.AssignmentDate.ToShortDateString()</td>
                            <td>
                                @if (assignment.ReturnDate.HasValue)
                                {
                                    @assignment.ReturnDate.Value.ToShortDateString()
                                }
                                else
                                {
                                    <span class="badge bg-primary">En cours</span>
                                }
                            </td>
                            <td>
                                @switch (assignment.ConditionAtAssignment)
                                {
                                    case ERP.Models.AssignmentCondition.New:
                                        <span class="badge bg-success">Neuf</span>
                                        break;
                                    case ERP.Models.AssignmentCondition.Good:
                                        <span class="badge bg-primary">Bon</span>
                                        break;
                                    case ERP.Models.AssignmentCondition.Fair:
                                        <span class="badge bg-warning">Correct</span>
                                        break;
                                    case ERP.Models.AssignmentCondition.Poor:
                                        <span class="badge bg-danger">Mauvais</span>
                                        break;
                                }
                            </td>
                            <td>
                                @if (assignment.ConditionAtReturn.HasValue)
                                {
                                    @switch (assignment.ConditionAtReturn.Value)
                                    {
                                        case ERP.Models.AssignmentCondition.New:
                                            <span class="badge bg-success">Neuf</span>
                                            break;
                                        case ERP.Models.AssignmentCondition.Good:
                                            <span class="badge bg-primary">Bon</span>
                                            break;
                                        case ERP.Models.AssignmentCondition.Fair:
                                            <span class="badge bg-warning">Correct</span>
                                            break;
                                        case ERP.Models.AssignmentCondition.Poor:
                                            <span class="badge bg-danger">Mauvais</span>
                                            break;
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p class="text-muted">Aucun historique d'attribution.</p>
        }
    </div>
</div>

<div class="mt-3">
    <a asp-action="Edit" asp-route-id="@Model.EquipmentId" class="btn btn-warning">Modifier</a>
    @if (Model.Status == ERP.Models.EquipmentStatus.Available)
    {
        <a asp-action="Assign" asp-route-id="@Model.EquipmentId" class="btn btn-success">Attribuer</a>
    }
    @if (Model.Status == ERP.Models.EquipmentStatus.Assigned)
    {
        <a asp-action="Return" asp-route-id="@Model.EquipmentId" class="btn btn-secondary">Enregistrer le retour</a>
    }
    <a asp-action="Delete" asp-route-id="@Model.EquipmentId" class="btn btn-danger">Supprimer</a>
    <a asp-action="Index" class="btn btn-outline-secondary">Retour à la liste</a>
</div>
