@model ERP.Models.Employe

@{
    ViewData["Title"] = $"Équipements de {Model.Prenom} {Model.Nom}";
    var activeAssignments = Model.EquipmentAssignments?.Where(a => a.ReturnDate == null).ToList() ?? new List<ERP.Models.EquipmentAssignment>();
    var pastAssignments = Model.EquipmentAssignments?.Where(a => a.ReturnDate != null).ToList() ?? new List<ERP.Models.EquipmentAssignment>();
}

<h1>Équipements de @Model.Prenom @Model.Nom</h1>

<div class="card mb-3">
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-3 col-5">Employé</dt>
            <dd class="col-sm-9 col-7">
                <a asp-controller="Employes" asp-action="Details" asp-route-id="@Model.Id">
                    @Model.Prenom @Model.Nom
                </a>
            </dd>
            <dt class="col-sm-3 col-5">Poste</dt>
            <dd class="col-sm-9 col-7">@Model.Poste?.Title (@Model.Poste?.Department)</dd>
            <dt class="col-sm-3 col-5">Email</dt>
            <dd class="col-sm-9 col-7">@Model.Email</dd>
            <dt class="col-sm-3 col-5">Embauche</dt>
            <dd class="col-sm-9 col-7">@Model.DateEmbauche.ToShortDateString()</dd>
        </dl>
    </div>
</div>

<h4>Équipements actuellement attribués <span class="badge bg-primary">@activeAssignments.Count</span></h4>
@if (activeAssignments.Any())
{
    <div class="card mb-3">
    <div class="table-responsive">
    <table class="table mb-0">
        <thead>
            <tr>
                <th>Équipement</th>
                <th class="d-none d-md-table-cell">Type</th>
                <th class="d-none d-lg-table-cell">Code</th>
                <th class="d-none d-sm-table-cell">Date</th>
                <th class="d-none d-md-table-cell">État</th>
                <th class="text-end">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var assignment in activeAssignments.OrderByDescending(a => a.AssignmentDate))
            {
                <tr>
                    <td>
                        <a asp-controller="Equipment" asp-action="Details" asp-route-id="@assignment.EquipmentId">
                            <strong>@assignment.Equipment?.Name</strong>
                        </a>
                        <br />
                        <small class="text-muted">@assignment.Equipment?.Brand @assignment.Equipment?.Model</small>
                        <span class="d-md-none d-block mt-1"><span class="badge bg-info">@assignment.Equipment?.EquipmentType?.Name</span></span>
                    </td>
                    <td class="d-none d-md-table-cell"><span class="badge bg-info">@assignment.Equipment?.EquipmentType?.Name</span></td>
                    <td class="d-none d-lg-table-cell"><code>@assignment.Equipment?.InventoryCode</code></td>
                    <td class="d-none d-sm-table-cell">@assignment.AssignmentDate.ToShortDateString()</td>
                    <td class="d-none d-md-table-cell">
                        @switch (assignment.ConditionAtAssignment)
                        {
                            case ERP.Models.AssignmentCondition.New:
                                <span class="badge bg-success">Neuf</span>
                                break;
                            case ERP.Models.AssignmentCondition.Good:
                                <span class="badge bg-primary">Bon</span>
                                break;
                            case ERP.Models.AssignmentCondition.Fair:
                                <span class="badge bg-warning">Correct</span>
                                break;
                            case ERP.Models.AssignmentCondition.Poor:
                                <span class="badge bg-danger">Mauvais</span>
                                break;
                        }
                    </td>
                    <td class="text-end">
                        <a asp-controller="Equipment" asp-action="Return" asp-route-id="@assignment.EquipmentId" class="btn btn-sm btn-warning">
                            <i class="bi bi-box-arrow-in-left"></i><span class="d-none d-md-inline ms-1">Retourner</span>
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    </div>
    </div>
}
else
{
    <div class="alert alert-info">
        Aucun équipement actuellement attribué à cet employé.
    </div>
}

<h4 class="mt-4">Historique des équipements <span class="badge bg-secondary">@pastAssignments.Count</span></h4>
@if (pastAssignments.Any())
{
    <div class="card mb-3">
    <div class="table-responsive">
    <table class="table mb-0">
        <thead>
            <tr>
                <th>Équipement</th>
                <th class="d-none d-md-table-cell">Type</th>
                <th class="d-none d-sm-table-cell">Attribution</th>
                <th class="d-none d-sm-table-cell">Retour</th>
                <th class="d-none d-md-table-cell">Durée</th>
                <th class="d-none d-lg-table-cell">État retour</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var assignment in pastAssignments.OrderByDescending(a => a.ReturnDate))
            {
                <tr>
                    <td>
                        <a asp-controller="Equipment" asp-action="Details" asp-route-id="@assignment.EquipmentId">
                            <strong>@assignment.Equipment?.Name</strong>
                        </a>
                        <span class="d-md-none d-block mt-1"><span class="badge bg-info">@assignment.Equipment?.EquipmentType?.Name</span></span>
                    </td>
                    <td class="d-none d-md-table-cell"><span class="badge bg-info">@assignment.Equipment?.EquipmentType?.Name</span></td>
                    <td class="d-none d-sm-table-cell">@assignment.AssignmentDate.ToShortDateString()</td>
                    <td class="d-none d-sm-table-cell">@assignment.ReturnDate?.ToShortDateString()</td>
                    <td class="d-none d-md-table-cell">
                        @{
                            var days = (assignment.ReturnDate.Value - assignment.AssignmentDate).Days;
                            if (days >= 30)
                            {
                                @($"{days / 30} mois")
                            }
                            else
                            {
                                @($"{days} jour(s)")
                            }
                        }
                    </td>
                    <td class="d-none d-lg-table-cell">
                        @if (assignment.ConditionAtReturn.HasValue)
                        {
                            @switch (assignment.ConditionAtReturn.Value)
                            {
                                case ERP.Models.AssignmentCondition.New:
                                    <span class="badge bg-success">Neuf</span>
                                    break;
                                case ERP.Models.AssignmentCondition.Good:
                                    <span class="badge bg-primary">Bon</span>
                                    break;
                                case ERP.Models.AssignmentCondition.Fair:
                                    <span class="badge bg-warning">Correct</span>
                                    break;
                                case ERP.Models.AssignmentCondition.Poor:
                                    <span class="badge bg-danger">Mauvais</span>
                                    break;
                            }
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
    </div>
    </div>
}
else
{
    <p class="text-muted">Aucun historique d'équipement pour cet employé.</p>
}

<div class="mt-3">
    <a asp-controller="Employes" asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">Retour au profil</a>
    <a asp-controller="Equipment" asp-action="Index" class="btn btn-outline-primary">Voir tous les équipements</a>
</div>
