@model ERP.Models.Employe

@{
    ViewData["Title"] = $"Équipements de {Model.Prenom} {Model.Nom}";
    var activeAssignments = Model.EquipmentAssignments?.Where(a => a.ReturnDate == null).ToList() ?? new List<ERP.Models.EquipmentAssignment>();
    var pastAssignments = Model.EquipmentAssignments?.Where(a => a.ReturnDate != null).ToList() ?? new List<ERP.Models.EquipmentAssignment>();
}

<h1>Équipements de @Model.Prenom @Model.Nom</h1>

<div class="card mb-3">
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-2">Employé</dt>
            <dd class="col-sm-4">
                <a asp-controller="Employes" asp-action="Details" asp-route-id="@Model.Id">
                    @Model.Prenom @Model.Nom
                </a>
            </dd>
            <dt class="col-sm-2">Poste</dt>
            <dd class="col-sm-4">@Model.Poste?.Title (@Model.Poste?.Department)</dd>
            <dt class="col-sm-2">Email</dt>
            <dd class="col-sm-4">@Model.Email</dd>
            <dt class="col-sm-2">Date d'embauche</dt>
            <dd class="col-sm-4">@Model.DateEmbauche.ToShortDateString()</dd>
        </dl>
    </div>
</div>

<h4>Équipements actuellement attribués <span class="badge bg-primary">@activeAssignments.Count</span></h4>
@if (activeAssignments.Any())
{
    <table class="table table-striped">
        <thead class="table-primary">
            <tr>
                <th>Équipement</th>
                <th>Type</th>
                <th>Code</th>
                <th>Date attribution</th>
                <th>État</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var assignment in activeAssignments.OrderByDescending(a => a.AssignmentDate))
            {
                <tr>
                    <td>
                        <a asp-controller="Equipment" asp-action="Details" asp-route-id="@assignment.EquipmentId">
                            @assignment.Equipment?.Name
                        </a>
                        <br />
                        <small class="text-muted">@assignment.Equipment?.Brand @assignment.Equipment?.Model</small>
                    </td>
                    <td><span class="badge bg-info">@assignment.Equipment?.EquipmentType?.Name</span></td>
                    <td><code>@assignment.Equipment?.InventoryCode</code></td>
                    <td>@assignment.AssignmentDate.ToShortDateString()</td>
                    <td>
                        @switch (assignment.ConditionAtAssignment)
                        {
                            case ERP.Models.AssignmentCondition.New:
                                <span class="badge bg-success">Neuf</span>
                                break;
                            case ERP.Models.AssignmentCondition.Good:
                                <span class="badge bg-primary">Bon</span>
                                break;
                            case ERP.Models.AssignmentCondition.Fair:
                                <span class="badge bg-warning">Correct</span>
                                break;
                            case ERP.Models.AssignmentCondition.Poor:
                                <span class="badge bg-danger">Mauvais</span>
                                break;
                        }
                    </td>
                    <td>
                        <a asp-controller="Equipment" asp-action="Return" asp-route-id="@assignment.EquipmentId" class="btn btn-sm btn-warning">
                            Retourner
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info">
        Aucun équipement actuellement attribué à cet employé.
    </div>
}

<h4 class="mt-4">Historique des équipements <span class="badge bg-secondary">@pastAssignments.Count</span></h4>
@if (pastAssignments.Any())
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Équipement</th>
                <th>Type</th>
                <th>Attribution</th>
                <th>Retour</th>
                <th>Durée</th>
                <th>État retour</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var assignment in pastAssignments.OrderByDescending(a => a.ReturnDate))
            {
                <tr>
                    <td>
                        <a asp-controller="Equipment" asp-action="Details" asp-route-id="@assignment.EquipmentId">
                            @assignment.Equipment?.Name
                        </a>
                    </td>
                    <td><span class="badge bg-info">@assignment.Equipment?.EquipmentType?.Name</span></td>
                    <td>@assignment.AssignmentDate.ToShortDateString()</td>
                    <td>@assignment.ReturnDate?.ToShortDateString()</td>
                    <td>
                        @{
                            var days = (assignment.ReturnDate.Value - assignment.AssignmentDate).Days;
                            if (days >= 30)
                            {
                                @($"{days / 30} mois")
                            }
                            else
                            {
                                @($"{days} jour(s)")
                            }
                        }
                    </td>
                    <td>
                        @if (assignment.ConditionAtReturn.HasValue)
                        {
                            @switch (assignment.ConditionAtReturn.Value)
                            {
                                case ERP.Models.AssignmentCondition.New:
                                    <span class="badge bg-success">Neuf</span>
                                    break;
                                case ERP.Models.AssignmentCondition.Good:
                                    <span class="badge bg-primary">Bon</span>
                                    break;
                                case ERP.Models.AssignmentCondition.Fair:
                                    <span class="badge bg-warning">Correct</span>
                                    break;
                                case ERP.Models.AssignmentCondition.Poor:
                                    <span class="badge bg-danger">Mauvais</span>
                                    break;
                            }
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p class="text-muted">Aucun historique d'équipement pour cet employé.</p>
}

<div class="mt-3">
    <a asp-controller="Employes" asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">Retour au profil</a>
    <a asp-controller="Equipment" asp-action="Index" class="btn btn-outline-primary">Voir tous les équipements</a>
</div>
